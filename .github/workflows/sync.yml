name: Sync GitHub Projects to Contentful

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all projects (ignore cache)'
        type: boolean
        default: false

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build
        run: go build -o sync .

      - name: Run sync
        env:
          GITHUB_USERNAME: alberto-moreno-sa
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CONTENTFUL_SPACE_ID: ${{ secrets.CONTENTFUL_SPACE_ID }}
          CONTENTFUL_CMA_TOKEN: ${{ secrets.CONTENTFUL_CMA_TOKEN }}
          CONTENTFUL_ENTRY_ID: ${{ secrets.CONTENTFUL_ENTRY_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          MAX_FEATURED: '5'
          MAX_PROJECTS: '15'
          FORCE_UPDATE: ${{ inputs.force_update || 'false' }}
        run: ./sync sync

      - name: Summary
        if: always()
        run: echo "Sync completed at $(date -u)" >> $GITHUB_STEP_SUMMARY
